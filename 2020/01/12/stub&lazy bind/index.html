<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> stub&lazy bind · Hexo</title><meta name="description" content="stub&amp;lazy bind - arderbud"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Hexo"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://weibo.com/" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/arderbud" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">stub&lazy bind</h1><div class="post-info">Jan 12, 2020</div><div class="post-content"><p> When i learn mach-o format before,i  just know a little about stub. Now i have enough  free time to study it. so record it. I try to explain how stubs work detaily,hope it can helpful. </p>
<h3 id="Tool"><a href="#Tool" class="headerlink" title="Tool"></a>Tool</h3><ul>
<li>Xcode</li>
<li>MachOView</li>
<li>Hopper Disassember </li>
<li><a href="https://opensource.apple.com/tarballs/dyld/" target="_blank" rel="noopener">dyld-551.3</a></li>
</ul>
<h3 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h3><h4 id="prepare"><a href="#prepare" class="headerlink" title="prepare"></a>prepare</h4><ol>
<li><p>Use <code>Xcode</code>start a <code>Command Line Tool</code>project in macOS, here i just named <code>stubDebug</code>for demonstrate. Then replace the default <code>NSLog(@&quot;Hello world&quot;);</code>to <code>printf(@&quot;Hello, World!\n&quot;);</code>,like below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        &#x2F;&#x2F; insert code here...</span><br><span class="line">        printf(&quot;Hello, World!\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li>Compile the project to generate the executable <code>stubDebug</code>(mach-o format),the drag it to both <code>MachOView</code>and <code>Hopper Disassember</code></li>
</ol>
<h4 id="analysis"><a href="#analysis" class="headerlink" title="analysis"></a>analysis</h4><p>In <code>Hopper Disassember</code>,let’s start with <code>_main</code>label,we can find  an instruction  below</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0000000100000f48         call       imp___stubs__printf</span><br></pre></td></tr></table></figure>

<p>this is the point where our source code<code>printf(&quot;Hello, World!\n&quot;);</code>execute.</p>
<p>Click the <code>imp___stubs__printf</code>label ,jump to </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0000000100000f6e         jmp        qword [_printf_ptr]</span><br></pre></td></tr></table></figure>

<p>Then click <code>_printf_prt</code>label, jump to</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0000000100001020         dq         _printf</span><br></pre></td></tr></table></figure>

<p>The <code>_printf</code>is just a tip,not a acture address.So we will find the address <code>0x100001020</code> in <code>MachOView</code>,it locates in <code>__DATA,_la_symbol_ptr</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100001020  0000000100000F98 Indirect Pointer [0x100001020 -&gt; _print]</span><br></pre></td></tr></table></figure>

<p>Then go to address <code>0x100000F98</code>,it locates in <code>__TXEXT,__stub_helper</code></p>
<p>For easy, we use <code>Hopper Disassember</code>to ayalysis go on.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">     ; Section __stub_helper</span><br><span class="line">0000000100000f74         lea        r11, qword [dyld_stub_binder_100001000+8]   ; CODE XREF&#x3D;0x100000f89, 0x100000f93, 0x100000f9d</span><br><span class="line">0000000100000f7b         push       r11</span><br><span class="line">0000000100000f7d         jmp        qword [dyld_stub_binder_100001000]          ; dyld_stub_binder</span><br><span class="line">0000000100000f83         db         0x90</span><br><span class="line">0000000100000f84         push       0x0</span><br><span class="line">0000000100000f89         jmp        0x100000f74</span><br><span class="line">0000000100000f8e         push       0x1f</span><br><span class="line">0000000100000f93         jmp        0x100000f74</span><br><span class="line">0000000100000f98         push       0x3f  ;</span><br><span class="line">0000000100000f9d         jmp        0x100000f74</span><br><span class="line"></span><br><span class="line">                     dyld_stub_binder_100001000:</span><br><span class="line">0000000100001000         dq         dyld_stub_binder                            ; DATA XREF&#x3D;0x100000f7d</span><br><span class="line">0000000100001008         dq         0x0000000000000000                          ; DATA XREF&#x3D;0x100000f74</span><br></pre></td></tr></table></figure>

<p>When we arrive in address <code>0x100000f98</code>, then we push <code>0x3f</code>, push <code>0x100001008</code>,then jump <code>dyld_stub_binder</code>.</p>
<p>What do <code>0x3f</code>and <code>0x100001008</code>mean? We will explain it for later, for now, we just consider they are two numberes.</p>
<p>Then wo search <code>dyld_sub_binder</code>in <code>dyld-551.3</code>source code. It’t a assembler code.We look at the <code>__x86_64__</code>architecture,</p>
<p>What a bad luck, it’s too long! Don’t lose heart.We will only  analysis  some instruction below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> movq		MH_PARAM_RBP(%rbp),%rdi	# call fastBindLazySymbol(loadercache, lazyinfo)</span><br><span class="line">movq		LP_PARAM_RBP(%rbp),%rsi</span><br><span class="line">call		__Z21_dyld_fast_stub_entryPvl</span><br><span class="line">movq		%rax,%r11		# copy jump target</span><br></pre></td></tr></table></figure>

<p>Then we search <code>fastBindLazySymbol</code>,it’s a <code>c++</code>code.The <code>0x3f</code>and <code>0x100001008</code>are two parameters here actually (0x3f -&gt; <code>lazyBindingInfoOffset</code>, 0x100001008 -&gt; <code>imageLoaderCache</code>)</p>
<p>Now,<code>imageLoaderCache</code>is  0x100001008, <code>*imageLoaderCache</code>is the data located in address <code>0x100001008</code>,we can find the the data in address <code>0x100001008</code> is <code>0x0000000</code> in <code>MachOView</code>. </p>
<p>So we will arrive at <code>dyld::findMappedRange</code>,it’t a  fast address-&gt;image lookups. Simply explain, it will find the ImageLoader* where address <code>0x100001008</code>locates in. It’s our <code>stubDebug</code>main executable certainly.</p>
<p>Then execute <code>doBindFastLazySymbol</code> function. Let’s look at the <code>ImageLoaderMachOCompressed::doBindFastLazySymbol</code></p>
<p>First will focus on code below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getLazyBindingInfo(lazyBindingInfoOffset, start, end, &amp;segIndex, &amp;segOffset, &amp;libraryOrdinal, &amp;symbolName, &amp;doneAfterBind)</span><br></pre></td></tr></table></figure>

<p>The code will analysis <code>Laze Binding Info</code>for offset <code>0x3f</code>.Open <code>MachOView</code> again, find <code>Dynamic Loader Info -&gt;Lazy Binding Info</code>.The <code>Lazy Binding Info</code> start as <code>0x100002020</code>, then add offset <code>0x3f</code>,we get address <code>0x10000205f</code>,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">10000205E 00                BIND_OPCODE_DONE</span><br><span class="line">10000205F 72                BIND_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB   segment(2)</span><br><span class="line">100002060 20                uleb128                                   offset(32)</span><br><span class="line">100002061 13                BIND_OPCODE_SET_DYLIB_ORDINAL_IMM         dylib(3)</span><br><span class="line">100002062 40                BIND_OPCODE_SET_SYMBOL_TRAILING_FLAGS_IMM falgs(0)</span><br><span class="line">100002063 5F7072696E746600  string                                    name(_printf)</span><br><span class="line">10000206B 90                BIND_OPCODE_DO_BIND</span><br></pre></td></tr></table></figure>

<p>The <code>MachOView</code>is already help us to explain the meaning for every filed. So we go back <code>ImageLoaderMachOCompressed::doBindFastLazySymbol</code> , know that:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">segIndex &#x3D; 2;    &#x2F;&#x2F; 0 is &#96;__PAGEZERO&#96;,1 is &#96;__TEXT&#96;,2 is &#96;__DATA&#96;</span><br><span class="line">segOffset &#x3D; 32;</span><br><span class="line">libraryOrdinal &#x3D; 3; &#x2F;&#x2F; 1:LC_LOAD_DYLIB(Foundation) 2:LC_LOAD_DYLIC(libobjc.A.dylib) 3:LC_LOAD_DYLIB(libSystem.B.dylib)</span><br><span class="line">symbolName &#x3D; &quot;_printf&quot;;</span><br></pre></td></tr></table></figure>

<p>The general idea for this <code>Lazy Binding Info</code>is go to <code>dylib(3)</code>find symbol <code>_printf</code>address , then fill the address in this <code>segment(2)</code> segment with <code>offset(32)</code>.</p>
<p>Then focus on code below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  uintptr_t address &#x3D; segActualLoadAddress(segIndex) + segOffset;</span><br><span class="line">result &#x3D; this-&gt;bindAt(context, address, BIND_TYPE_POINTER, symbolName, 0, 0, libraryOrdinal, &quot;lazy &quot;, NULL, true);</span><br></pre></td></tr></table></figure>

<p><code>segIndex =2</code>，is’s <code>__DATA</code>segment.(0 is <code>__PAGEZERO</code>,1 is <code>__TEXT</code>,2 is <code>__DATA</code>).</p>
<p>Follow the <code>segActualLoadAddress</code>function,look at the <code>LC_SEGMENT_64(__DATA)</code>in <code>MachOView</code>,The VM Address is <code>0x100001000</code>，then add offset 0x20(segOffset=32),we get address = 0x100001020; It is the <code>_printf</code>placeholer. We know it before actually ,the <code>0x100001020</code>will jump <code>__stub_helper</code>before ,but now we will fill in actual address of  <code>_printf</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100001020  0000000100000F98 Indirect Pointer [0x100001020 -&gt; _print]</span><br></pre></td></tr></table></figure>

<p>Then look at <code>bindAt</code>function,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> &#x2F;&#x2F; resolve symbol</span><br><span class="line">symbolAddress &#x3D; this-&gt;resolve(context, symbolName, symbolFlags, libraryOrdinal, &amp;targetImage, last, runResolver);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; do actual update</span><br><span class="line">return this-&gt;bindLocation(context, addr, symbolAddress, type, symbolName, addend, this-&gt;getPath(), targetImage ? targetImage-&gt;getPath() : NULL, msg);</span><br></pre></td></tr></table></figure>

<p>The <code>resolve</code> call stack is  almost follows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-resolve()</span><br><span class="line">  -libImage((unsigned int)libraryOrdinal-1)</span><br><span class="line">  -resolveTwolevel()</span><br><span class="line">    -findExportedSymbolAddress()</span><br><span class="line">      -findExportedSymbol()</span><br><span class="line">        -ImageLoaderMachOCompressed::findShallowExportedSymbol()</span><br><span class="line">      -getExportedSymbolAddress()</span><br></pre></td></tr></table></figure>

<p>Let’s focus on <code>libImage((unsigned int)libraryOrdinal-1)</code>first. the <code>libraryOrdinal</code>is 3 actually depend on above.In this <code>stubDebug</code>project,libImage(3-1) mean <code>libSystem.B.dylib</code>.Why? We can see <code>stubDebug</code> in <code>MachOView</code> for <code>Load Commands</code>part. We can see </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LC_LOAD_DYLIB(Foundation)</span><br><span class="line">LC_LOAD_DYLIB(libobjc.A.dylib)</span><br><span class="line">LC_LOAD_DYLIB(libSystem.B.dylib)</span><br></pre></td></tr></table></figure>

<p>Then focus on <code>findExportedSymbol</code>, <del>Because <code>libSystem.B.dylib</code>is a collection of <code>libsystem_c.dylib</code>,<code>libsystem_kernal.dylib</code>…… It will look up for ecah,(I just guess).</del></p>
<p>We know <code>_printf</code>is in <code>libsystem_c.dylib,</code>,so we assume we are in <code>libsystem_c.dylib</code>,then execute <code>findShallowExportedSymbol</code>,this function look up <code>Dynamic Loader Info</code> -&gt;<code>Export Info</code> of  <code>libsystem_c.dylib</code></p>
<p>Open <code>libsystem_c.dylib</code>in<code>MachOView</code>,The <code>Export Info</code>is a trie,we can find <code>_printf</code> in logic below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">92972 5F00 Node Lable &#39;_&#39;</span><br><span class="line">92974 25   Next Node  0x92980</span><br><span class="line">      929E9 7000 Node Label &#39;p&#39;</span><br><span class="line">      929EB 8F3C Next Node 0x94777</span><br><span class="line">            94700 72696E746600 Node Label &#39;rintf&#39;</span><br><span class="line">            9779F B08401       Next Node   0x96B98</span><br><span class="line">                  96B9A C49D10  Symbol Offset Ox40EC4</span><br></pre></td></tr></table></figure>

<p>Now, we get the symbol offset 0x40EC4,this is  the address of the symbol <code>_printf</code>actually.We can confirm it in <code>Hopper Disassembler</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">                     _printf:</span><br><span class="line">0000000000040ec4         push       rbp</span><br></pre></td></tr></table></figure>



<p>Now,We find the address of symbol <code>_printf</code>, and we also know we should bind it to <code>stubDebug</code>‘s address <code>0x100001020</code>in <code>__DATA,_la_symbol_ptr</code>,to replace <code>__TEXT,__stub_helper</code>with<code>_printf</code>,We finish the lazy bind.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/01/03/dyld%20overview/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://yoursite.com">arderbud</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>